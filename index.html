<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloudflare 优选实时测速</title>
    <style>
      :root {
        --bg: #f4f7fb;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #2563eb;
        --card: #ffffff;
        --border: #e5e7eb;
        --ok: #16a34a;
        --warn: #d97706;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        color: var(--text);
        background: radial-gradient(circle at 10% -10%, #dbeafe 0, transparent 35%), var(--bg);
      }
      .wrap {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 36px;
      }
      h1 {
        margin: 0;
        font-size: clamp(1.5rem, 4vw, 2.1rem);
      }
      .sub {
        color: var(--muted);
        margin: 8px 0 20px;
      }
      .cards {
        display: grid;
        gap: 14px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
        box-shadow: 0 6px 20px rgba(15, 23, 42, 0.05);
      }
      .domain { font-weight: 700; word-break: break-all; }
      .tag { color: var(--muted); font-size: 0.9rem; margin-top: 4px; }
      .detail { color: var(--muted); font-size: 0.86rem; margin-top: 6px; }
      .latency {
        min-width: 130px;
        text-align: right;
        font-size: 1.25rem;
        font-weight: 800;
      }
      .latency.ok { color: var(--ok); }
      .latency.warn { color: var(--warn); }
      .controls {
        margin-top: 16px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      button {
        border-radius: 10px;
        border: 1px solid transparent;
        padding: 10px 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .btn-main { background: var(--primary); color: #fff; }
      .btn-ghost { background: #fff; border-color: var(--border); color: var(--text); }
      .summary {
        margin-top: 16px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px 14px;
        color: var(--muted);
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        background: var(--ok);
        margin-right: 8px;
      }
      .summary strong { color: var(--primary); }
    </style>
  </head>
  <body>
    <main class="wrap">
      <h1>☁️ Cloudflare 优选实时测速</h1>
      <p class="sub">参考站点风格调整：浅色卡片布局 + 实时刷新。每 2 秒对两个域名并行测速一次。</p>
      <p class="sub" style="margin-top:-8px">参考页面：<a href="https://cf.090227.xyz/" target="_blank" rel="noreferrer">https://cf.090227.xyz/</a></p>

      <section class="cards" id="cards"></section>

      <div class="controls">
        <button class="btn-main" id="toggle">暂停实时测速</button>
        <button class="btn-ghost" id="reset">重置统计</button>
      </div>

      <p class="summary" id="summary"><span class="status-dot"></span>初始化中...</p>
    </main>

    <script>
      const endpoints = [
        { name: "我的优选", domain: "cf.te.lezi.chat" },
        { name: "对照组", domain: "youxuan.cf.090227.xyz" }
      ];
      const INTERVAL_MS = 2000;
      const TIMEOUT_MS = 4000;
      const HISTORY_LIMIT = 20;

      const cardsEl = document.querySelector("#cards");
      const summaryEl = document.querySelector("#summary");
      const toggleBtn = document.querySelector("#toggle");
      const resetBtn = document.querySelector("#reset");

      const state = new Map(endpoints.map((e) => [e.domain, { history: [], fails: 0, last: null }]));
      let timer = null;

      function avg(values) {
        return values.length ? values.reduce((a, b) => a + b, 0) / values.length : null;
      }

      function renderCards() {
        cardsEl.innerHTML = endpoints
          .map(
            (e) => `
              <article class="card">
                <div>
                  <div class="domain">${e.domain}</div>
                  <div class="tag">${e.name}</div>
                  <div class="detail" data-detail="${e.domain}">样本 0｜平均 -｜失败 0</div>
                </div>
                <div class="latency" data-latency="${e.domain}">待测试</div>
              </article>
            `
          )
          .join("");
      }

      function renderDomain(domain) {
        const item = state.get(domain);
        const latencyEl = document.querySelector(`[data-latency="${domain}"]`);
        const detailEl = document.querySelector(`[data-detail="${domain}"]`);
        if (!item || !latencyEl || !detailEl) return;

        latencyEl.classList.remove("ok", "warn");
        latencyEl.textContent = item.last === null ? "超时" : `${Math.round(item.last)} ms`;
        latencyEl.classList.add(item.last !== null && item.last < 350 ? "ok" : "warn");

        const a = avg(item.history);
        detailEl.textContent = `样本 ${item.history.length}｜平均 ${a === null ? "-" : `${Math.round(a)} ms`}｜失败 ${item.fails}`;
      }

      function renderSummary(running) {
        const records = endpoints.map((e) => ({ domain: e.domain, average: avg(state.get(e.domain).history) }));
        const valid = records.filter((r) => typeof r.average === "number");
        if (valid.length < 2) {
          summaryEl.innerHTML = `<span class="status-dot"></span>${running ? "实时测速中" : "已暂停"}：等待两个域名都有有效样本...`;
          return;
        }
        valid.sort((a, b) => a.average - b.average);
        const diff = Math.round(valid[1].average - valid[0].average);
        summaryEl.innerHTML = `<span class="status-dot"></span>${running ? "实时测速中" : "已暂停"}：当前平均更快 <strong>${valid[0].domain}</strong>，约快 ${diff} ms。`;
      }

      async function measure(domain) {
        const start = performance.now();
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), TIMEOUT_MS);

        try {
          await fetch(`https://${domain}/cdn-cgi/trace?ts=${Date.now()}-${Math.random()}`, {
            mode: "no-cors",
            cache: "no-store",
            signal: controller.signal
          });
          return performance.now() - start;
        } catch {
          return null;
        } finally {
          clearTimeout(t);
        }
      }

      async function runRound() {
        const result = await Promise.all(endpoints.map(async (e) => ({ domain: e.domain, latency: await measure(e.domain) })));
        for (const row of result) {
          const item = state.get(row.domain);
          item.last = row.latency;
          if (row.latency === null) item.fails += 1;
          else {
            item.history.push(row.latency);
            if (item.history.length > HISTORY_LIMIT) item.history.shift();
          }
          renderDomain(row.domain);
        }
        renderSummary(Boolean(timer));
      }

      function start() {
        if (timer) return;
        runRound();
        timer = setInterval(runRound, INTERVAL_MS);
        toggleBtn.textContent = "暂停实时测速";
        renderSummary(true);
      }

      function stop() {
        if (!timer) return;
        clearInterval(timer);
        timer = null;
        toggleBtn.textContent = "继续实时测速";
        renderSummary(false);
      }

      function reset() {
        for (const e of endpoints) {
          state.set(e.domain, { history: [], fails: 0, last: null });
          renderDomain(e.domain);
        }
        renderSummary(Boolean(timer));
      }

      toggleBtn.addEventListener("click", () => (timer ? stop() : start()));
      resetBtn.addEventListener("click", reset);

      renderCards();
      reset();
      start();
    </script>
  </body>
</html>
